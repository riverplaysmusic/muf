---
import Layout from "@/components/Layout.astro";
import { readdir, readFile, stat } from "node:fs/promises";
import { join } from "node:path";

export async function getStaticPaths() {
  const albumsDir = join(process.cwd(), "public", "albums");
  const items = await readdir(albumsDir);

  const paths = [];

  for (const item of items) {
    const itemPath = join(albumsDir, item);
    const itemStat = await stat(itemPath);

    if (itemStat.isDirectory()) {
      // Check if album.txt exists
      try {
        await readFile(join(itemPath, "album.txt"), "utf-8");
        paths.push({ params: { slug: item } });
      } catch {
        // Skip folders without album.txt
      }
    }
  }

  return paths;
}

const { slug } = Astro.params;

// Read album folder
const albumsDir = join(process.cwd(), "public", "albums");
const albumPath = join(albumsDir, slug);
const albumFilePath = join(albumPath, "album.txt");
let artworkFile: string | null = null;

// Look for artwork
const folderFiles = await readdir(albumPath);
const artwork = folderFiles.find((f) =>
  /^artwork\.(jpg|jpeg|png|svg|webp)$/i.test(f)
);
if (artwork) {
  artworkFile = `/albums/${slug}/${artwork}`;
}

// Read and parse album.txt
const content = await readFile(albumFilePath, "utf-8");
const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
const frontmatter = frontmatterMatch?.[1] || "";
const title = frontmatter.match(/title:\s*(.+)/)?.[1] || "Untitled";
const artist = frontmatter.match(/artist:\s*(.+)/)?.[1] || "";
const date = frontmatter.match(/date:\s*(.+)/)?.[1] || "";
const priceCents = parseInt(frontmatter.match(/price_cents:\s*(\d+)/)?.[1] || "0");
const length = frontmatter.match(/length:\s*(.+)/)?.[1] || "";
const recordingStudio = frontmatter.match(/recording_studio:\s*(.+)/)?.[1] || "";
const label = frontmatter.match(/label:\s*(.+)/)?.[1] || "";
const website = frontmatter.match(/website:\s*(.+)/)?.[1] || "";
const copyright = frontmatter.match(/copyright:\s*(.+)/)?.[1] || "";
const thanks = frontmatter.match(/thanks:\s*(.+)/)?.[1] || "";

// Parse tracks with credits
interface Track {
  name: string;
  credits?: string[];
}
const tracks: Track[] = [];
const tracksMatch = frontmatter.match(/tracks:\s*\n([\s\S]*?)(?=\n\w+:|$)/);
if (tracksMatch) {
  const trackLines = tracksMatch[1].split("\n");
  let currentTrack: Track | null = null;

  for (const line of trackLines) {
    const nameMatch = line.match(/^\s*-\s*name:\s*(.+)/);
    const creditMatch = line.match(/^\s*-\s*(.+)/);

    if (nameMatch) {
      if (currentTrack) tracks.push(currentTrack);
      currentTrack = { name: nameMatch[1].trim() };
    } else if (creditMatch && currentTrack && line.includes("    -")) {
      if (!currentTrack.credits) currentTrack.credits = [];
      currentTrack.credits.push(creditMatch[1].trim());
    }
  }
  if (currentTrack) tracks.push(currentTrack);
}

// Parse album-wide credits
const albumCreditsMatch = frontmatter.match(/^credits:\s*\n([\s\S]*?)(?=\n\w+:|$)/m);
let albumCredits: string[] = [];
if (albumCreditsMatch) {
  albumCredits = albumCreditsMatch[1]
    .split("\n")
    .map((line) => line.replace(/^\s*-\s*/, "").trim())
    .filter((line) => line.length > 0);
}

const body = content.replace(/^---\n[\s\S]*?\n---\n/, "").trim();
const paragraphs = body.split("\n\n");

// Determine if content is paid
const isPaid = priceCents > 0;
const price = (priceCents / 100).toFixed(2);

// For now, show full content if free, preview if paid
const isPreviewMode = isPaid;
const previewParagraphs = isPreviewMode ? [paragraphs[0]] : paragraphs;
---

<Layout>
  <script>
    import { supabase } from "@/lib/supabase";

    // Check for success/cancel query params
    const urlParams = new URLSearchParams(window.location.search);

    if (urlParams.get('success') === 'true') {
      alert('Payment successful! Your album is now available for download.\n\nIf the download button doesn\'t appear, please refresh the page.\n\nIf you have an issue, please contact web@musicaluniversefactory.com');
      window.history.replaceState({}, '', window.location.pathname);
      location.reload();
    }

    if (urlParams.get('canceled') === 'true') {
      alert('Purchase canceled. You can complete your purchase anytime.');
      window.history.replaceState({}, '', window.location.pathname);
    }

    const isPaid = document.getElementById("is-paid")?.dataset.value === "true";
    const slug = document.getElementById("album-slug")?.dataset.value;
    const fullContent = document.getElementById("full-content");
    const previewContent = document.getElementById("preview-content");
    const buySection = document.getElementById("buy-section");
    const downloadSection = document.getElementById("download-section");
    const loadingMsg = document.getElementById("loading-msg");
    const purchaseBtn = document.getElementById("purchase-btn");
    const downloadBtn = document.getElementById("download-btn");

    async function checkOwnership() {
      if (!isPaid) return;

      // Check if user is logged in
      const { data: { session } } = await supabase.auth.getSession();

      if (!session) {
        // Not logged in, show preview + buy
        loadingMsg?.classList.add("hidden");
        previewContent?.classList.remove("hidden");
        buySection?.classList.remove("hidden");
        return;
      }

      // Check if user owns this album
      const { data: product } = await supabase
        .from('products')
        .select('id')
        .eq('slug', slug)
        .single();

      if (!product) {
        console.error('Product not found');
        return;
      }

      const { data: purchase } = await supabase
        .from('purchases')
        .select('id')
        .eq('user_id', session.user.id)
        .eq('product_id', product.id)
        .single();

      loadingMsg?.classList.add("hidden");

      if (purchase) {
        // User owns it, show full content + download
        fullContent?.classList.remove("hidden");
        downloadSection?.classList.remove("hidden");
      } else {
        // User doesn't own it, show preview + buy
        previewContent?.classList.remove("hidden");
        buySection?.classList.remove("hidden");
      }
    }

    // Handle purchase button click
    purchaseBtn?.addEventListener("click", async () => {
      if (!purchaseBtn) return;
      purchaseBtn.disabled = true;
      purchaseBtn.textContent = "Loading...";

      try {
        const { data: { session } } = await supabase.auth.getSession();

        // If not logged in, redirect to account page
        if (!session) {
          window.location.href = '/account';
          return;
        }

        const response = await fetch('/api/create-checkout-session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`,
          },
          body: JSON.stringify({ productSlug: slug }),
        });

        const data = await response.json();

        if (!response.ok || data.error) {
          alert(`Error: ${data.error || 'Failed to create checkout session'}`);
          purchaseBtn.disabled = false;
          purchaseBtn.textContent = "Purchase Now";
          return;
        }

        // Redirect to Stripe Checkout
        window.location.href = data.url;

      } catch (err: any) {
        alert(`Error: ${err.message}`);
        purchaseBtn.disabled = false;
        purchaseBtn.textContent = "Purchase Now";
      }
    });

    // Handle download button click
    downloadBtn?.addEventListener("click", async () => {
      try {
        const { data: { session } } = await supabase.auth.getSession();

        if (!session) {
          alert('Please sign in to download');
          window.location.href = '/account';
          return;
        }

        // Get product and file info
        const { data: product } = await supabase
          .from('products')
          .select('id')
          .eq('slug', slug)
          .single();

        if (!product) {
          alert('Product not found');
          return;
        }

        const { data: file } = await supabase
          .from('product_files')
          .select('file_url')
          .eq('product_id', product.id)
          .eq('format', 'flac')
          .single();

        if (!file) {
          alert('Download file not found');
          return;
        }

        // Get signed download URL from Supabase Storage
        const { data: signedUrl, error } = await supabase.storage
          .from('albums')
          .createSignedUrl(file.file_url, 3600); // 1 hour expiry

        if (error) throw error;

        // Trigger download
        window.location.href = signedUrl.signedUrl;

      } catch (err: any) {
        alert(`Download failed: ${err.message}`);
      }
    });

    checkOwnership();
  </script>

  <main class="brochure">
    <!-- HERO -->
    <section class="hero no-padding-image">
      {artworkFile && (
        <div class="hero-artwork">
          <img src={artworkFile} alt={title} />
        </div>
      )}
      <header class="content">
        <a href="/albums" class="back-link">‚Üê Back to Albums</a>
        <h1 class="gradient-cyan-pink">{title}</h1>
        {artist && <p class="subtitle artist-name">{artist}</p>}
        {date && (
          <time class="subtitle">{new Date(date).toLocaleDateString()}</time>
        )}
        {isPaid && (
          <p class="subtitle price-tag">
            ${price}
          </p>
        )}
      </header>
    </section>

    <!-- CONTENT GRID -->
    <div class="content-grid">
      <!-- LEFT COLUMN: TRACKS & INFO -->
      <div class="left-column">
        <!-- ALBUM INFO -->
        <section class="card album-info-card">
          <div class="info-grid">
            {artist && (
              <div class="info-item">
                <span class="info-label">Artist</span>
                <span class="info-value">{artist}</span>
              </div>
            )}
            {date && (
              <div class="info-item">
                <span class="info-label">Released</span>
                <span class="info-value">{new Date(date).getFullYear()}</span>
              </div>
            )}
            {tracks.length > 0 && (
              <div class="info-item">
                <span class="info-label">Tracks</span>
                <span class="info-value">{tracks.length}</span>
              </div>
            )}
            {length && (
              <div class="info-item">
                <span class="info-label">Length</span>
                <span class="info-value">{length}</span>
              </div>
            )}
            <div class="info-item">
              <span class="info-label">Format</span>
              <span class="info-value">FLAC</span>
            </div>
          </div>
        </section>

        <!-- TRACKS -->
        {tracks.length > 0 && (
          <section class="card tracks-card">
            <h2 class="card-title">Track Listing</h2>
            <ol class="track-list">
              {tracks.map((track, index) => (
                <li class="track-item">
                  <span class="track-number">{String(index + 1).padStart(2, '0')}</span>
                  <span class="track-name">{track.name}</span>
                </li>
              ))}
            </ol>
          </section>
        )}

        <!-- CREDITS -->
        {(tracks.some(t => t.credits?.length) || albumCredits.length > 0 || label || recordingStudio || website || thanks || copyright) && (
          <section class="card credits-card">
            <h2 class="card-title">Credits</h2>

            {tracks.map((track) => (
              track.credits && track.credits.length > 0 && (
                <div class="track-credits">
                  <h3 class="track-credits-title">{track.name}</h3>
                  <ul class="credit-items">
                    {track.credits.map((credit) => (
                      <li class="credit-item">{credit}</li>
                    ))}
                  </ul>
                </div>
              )
            ))}

            {albumCredits.length > 0 && (
              <div class="album-credits">
                <ul class="credit-items">
                  {albumCredits.map((credit) => (
                    <li class="credit-item">{credit}</li>
                  ))}
                </ul>
              </div>
            )}

            {(label || recordingStudio || website || thanks || copyright) && (
              <div class="album-meta">
                {label && <p class="meta-item"><span class="meta-label">Label:</span> {label}</p>}
                {recordingStudio && <p class="meta-item"><span class="meta-label">Recording Studio:</span> {recordingStudio}</p>}
                {website && (
                  <p class="meta-item">
                    <span class="meta-label">Website:</span>{' '}
                    <a href={website} target="_blank" rel="noopener noreferrer" class="meta-link">
                      {website.replace(/^https?:\/\//, '')}
                    </a>
                  </p>
                )}
                {thanks && <p class="meta-item"><span class="meta-label">Thanks:</span> {thanks}</p>}
                {copyright && <p class="meta-item copyright">{copyright}</p>}
              </div>
            )}
          </section>
        )}
      </div>

      <!-- RIGHT COLUMN: DESCRIPTION -->
      <div class="right-column">
        <!-- Hidden data for client script -->
        <div id="is-paid" data-value={isPaid.toString()} style="display:none;"></div>
        <div id="album-slug" data-value={slug} style="display:none;"></div>

        <section class="card description-section">
          <h2 class="card-title">About This Album</h2>

          {!isPaid ? (
            <!-- FREE CONTENT: Show immediately -->
            <div id="full-content" class="album-description">
              {paragraphs.map((paragraph) => (
                <p>{paragraph}</p>
              ))}
            </div>
          ) : (
            <>
              <!-- LOADING STATE -->
              <div id="loading-msg" class="stack center">
                <p class="desc">Checking access...</p>
              </div>

              <!-- PREVIEW CONTENT (shown if not owned) -->
              <div id="preview-content" class="hidden">
                <div class="album-description">
                  {previewParagraphs.map((paragraph) => (
                    <p>{paragraph}</p>
                  ))}
                </div>
                <div class="fade-overlay"></div>
              </div>

              <!-- FULL CONTENT (shown if owned) -->
              <div id="full-content" class="hidden album-description">
                {paragraphs.map((paragraph) => (
                  <p>{paragraph}</p>
                ))}
              </div>
            </>
          )}
        </section>

        <!-- BUY SECTION -->
        {isPaid && (
          <section id="buy-section" class="card buy-section hidden">
            <h3 class="card-title gradient-cyan-pink">Own This Album</h3>
            <p class="buy-desc">
              Purchase for lifetime access to high-quality FLAC files.
            </p>
            <p class="buy-price">${price}</p>
            <button id="purchase-btn" class="btn retro">
              Purchase Now
            </button>
          </section>
        )}

        <!-- DOWNLOAD SECTION (shown if owned) -->
        {isPaid && (
          <section id="download-section" class="card download-section hidden">
            <h3 class="card-title gradient-cyan-pink">You Own This Album</h3>
            <p class="download-desc">
              Download your high-quality FLAC files anytime.
            </p>
            <button id="download-btn" class="btn retro">
              Download FLAC (ZIP)
            </button>
          </section>
        )}
      </div>
    </div>
  </main>
</Layout>

<style>
  /* --- HERO --- */
  .hero-artwork {
    width: 100%;
  }

  .hero-artwork img {
    width: 100%;
    height: auto;
    display: block;
  }

  .hero.no-padding-image {
    padding: 0;
  }

  .hero.no-padding-image .content {
    padding: var(--space-lg);
  }

  .back-link {
    display: inline-block;
    margin-bottom: var(--space-sm);
    opacity: 0.8;
    font-size: 0.9rem;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .back-link:hover {
    opacity: 1;
    text-decoration: underline;
    letter-spacing: 0.1em;
  }

  .artist-name {
    opacity: 0.9;
    font-size: 1.2rem;
  }

  .price-tag {
    background: linear-gradient(135deg, #00ffff, #ff00ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: bold;
    font-size: 1.5rem;
  }

  time.subtitle {
    opacity: 0.7;
  }

  /* --- CONTENT GRID --- */
  .content-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-md);
    max-width: 900px;
    margin: 0 auto;
    padding: 0 var(--space-lg);
  }

  @media (min-width: 1024px) {
    .content-grid {
      grid-template-columns: 380px 1fr;
      gap: var(--space-lg);
    }
  }

  .left-column,
  .right-column {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  /* --- CARD TITLES --- */
  .card-title {
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: var(--space-md);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* --- ALBUM INFO CARD --- */
  .album-info-card {
    padding: var(--space-lg);
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-md);
  }

  .info-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .info-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    opacity: 0.6;
    font-weight: 600;
  }

  .info-value {
    font-size: 1.15rem;
    font-weight: 700;
    color: white;
  }

  /* --- TRACKS CARD --- */
  .tracks-card {
    padding: var(--space-lg);
  }

  .track-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .track-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: rgba(0, 255, 255, 0.05);
    border-left: 3px solid var(--primary-cyan);
    transition: all 0.2s ease;
  }

  .track-item:hover {
    background: rgba(0, 255, 255, 0.1);
    transform: translateX(4px);
  }

  .track-number {
    font-size: 1.3rem;
    font-weight: 900;
    color: var(--primary-cyan);
    min-width: 2.5rem;
    font-variant-numeric: tabular-nums;
  }

  .track-name {
    font-size: 1rem;
    flex: 1;
  }

  /* --- CREDITS CARD --- */
  .credits-card {
    padding: var(--space-lg);
  }

  .track-credits {
    margin-bottom: var(--space-lg);
  }

  .track-credits:last-of-type {
    margin-bottom: var(--space-md);
  }

  .track-credits-title {
    font-size: 0.85rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.7;
    margin-bottom: var(--space-sm);
  }

  .credit-items {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .credit-item {
    font-size: 0.95rem;
    padding: var(--space-xs) var(--space-sm);
    background: rgba(255, 0, 255, 0.05);
    border-left: 2px solid var(--primary-pink);
  }

  .album-credits {
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .album-meta {
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .meta-item {
    font-size: 0.95rem;
    margin-bottom: var(--space-xs);
  }

  .meta-item:last-child {
    margin-bottom: 0;
  }

  .meta-label {
    font-weight: 700;
    opacity: 0.7;
  }

  .meta-link {
    color: white;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .meta-link:hover {
    text-decoration: underline;
    letter-spacing: 0.05em;
  }

  .copyright {
    margin-top: var(--space-sm);
    padding-top: var(--space-sm);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
    font-size: 0.85rem;
    opacity: 0.6;
    text-align: center;
  }

  /* --- DESCRIPTION SECTION --- */
  .description-section {
    padding: var(--space-lg);
  }

  .album-description {
    font-size: 1.05rem;
    line-height: 1.7;
  }

  .album-description p {
    margin-bottom: var(--space-md);
  }

  .album-description p:last-child {
    margin-bottom: 0;
  }

  /* --- PREVIEW & BUY --- */
  #preview-content {
    position: relative;
    padding-bottom: 2rem;
  }

  .fade-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 120px;
    background: linear-gradient(to bottom, transparent, var(--space-black));
    pointer-events: none;
  }

  .buy-section {
    text-align: center;
  }

  .buy-desc {
    font-size: 1rem;
    opacity: 0.9;
    margin-bottom: var(--space-md);
  }

  .buy-price {
    font-size: 2.5rem;
    font-weight: 900;
    background: linear-gradient(135deg, var(--primary-cyan), var(--primary-pink));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-top: 0;
    margin-bottom: var(--space-lg);
  }

  .buy-section .btn {
    font-size: 1.1rem;
    padding: var(--space-sm) var(--space-lg);
  }

  /* --- DOWNLOAD SECTION --- */
  .download-section {
    text-align: center;
  }

  .download-desc {
    font-size: 1rem;
    opacity: 0.9;
    margin-bottom: var(--space-lg);
  }

  .download-section .btn {
    font-size: 1.1rem;
    padding: var(--space-sm) var(--space-lg);
  }

  /* --- UTILITIES --- */
  .hidden {
    display: none;
  }

  .error {
    color: #ff4444;
  }

  /* --- MOBILE --- */
  @media (max-width: 768px) {
    .hero.no-padding-image .content {
      padding: var(--space-md);
    }

    .content-grid {
      padding: 0 var(--space-md);
      gap: var(--space-lg);
    }

    .album-info-card,
    .tracks-card,
    .credits-card,
    .description-section {
      padding: var(--space-lg);
    }

    .card-title {
      font-size: 1.4rem;
    }

    .info-grid {
      gap: var(--space-md);
    }

    .track-number {
      font-size: 1.2rem;
      min-width: 2.5rem;
    }

    .track-name {
      font-size: 1rem;
    }

    .track-credits-title {
      font-size: 0.8rem;
    }

    .credit-item {
      font-size: 0.9rem;
    }

    .buy-price {
      font-size: 2rem;
    }
  }
</style>
