---
import Layout from "@/components/Layout.astro";
import { readdir, readFile, stat } from "node:fs/promises";
import { join } from "node:path";

// Scan all directories in public/slugs for content
const slugsDir = join(process.cwd(), "public", "slugs");
const items = await readdir(slugsDir);

const allItems: any[] = [];

for (const item of items) {
  const itemPath = join(slugsDir, item);

  try {
    const itemStat = await stat(itemPath);

    // Skip non-directories
    if (!itemStat.isDirectory()) continue;

    const slug = item;
    const files = await readdir(itemPath);

    // Check for album
    if (files.includes('album.txt')) {
      try {
        const content = await readFile(join(itemPath, 'album.txt'), 'utf-8');
        const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
        if (!frontmatterMatch) continue;

        const frontmatter = frontmatterMatch[1];
        const title = frontmatter.match(/title:\s*(.+)/)?.[1] || 'Untitled';
        const date = frontmatter.match(/date:\s*(.+)/)?.[1] || '';
        const priceCents = parseInt(frontmatter.match(/price_cents:\s*(\d+)/)?.[1] || '0');
        const published = frontmatter.match(/published:\s*(true|false)/)?.[1] === 'true';

        if (!published) continue;

        // Look for artwork
        const artwork = files.find((f) => /^artwork\.(jpg|jpeg|png|svg|webp)$/i.test(f));
        const artworkFile = artwork ? `/slugs/${slug}/${artwork}` : null;

        allItems.push({
          type: 'album',
          slug,
          title,
          date,
          priceCents,
          image: artworkFile,
          url: `/${slug}`
        });
      } catch {}
    }

    // Check for writing
    if (files.includes('writing.txt')) {
      try {
        const content = await readFile(join(itemPath, 'writing.txt'), 'utf-8');
        const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
        if (!frontmatterMatch) continue;

        const frontmatter = frontmatterMatch[1];
        const title = frontmatter.match(/title:\s*(.+)/)?.[1] || 'Untitled';
        const date = frontmatter.match(/date:\s*(.+)/)?.[1] || '';
        const priceCents = parseInt(frontmatter.match(/price_cents:\s*(\d+)/)?.[1] || '0');
        const published = frontmatter.match(/published:\s*(true|false)/)?.[1] === 'true';

        if (!published) continue;

        // Look for artwork
        const artwork = files.find((f) => /^artwork\.(jpg|jpeg|png|svg|webp)$/i.test(f));
        const artworkFile = artwork ? `/slugs/${slug}/${artwork}` : null;

        allItems.push({
          type: 'writing',
          slug,
          title,
          date,
          priceCents,
          image: artworkFile,
          url: `/${slug}`
        });
      } catch {}
    }

    // Check for artwork
    if (files.includes('item.txt')) {
      try {
        const content = await readFile(join(itemPath, 'item.txt'), 'utf-8');
        const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
        if (!frontmatterMatch) continue;

        const frontmatter = frontmatterMatch[1];
        const title = frontmatter.match(/title:\s*(.+)/)?.[1] || 'Untitled';
        const date = frontmatter.match(/date:\s*(.+)/)?.[1] || '';
        const priceCents = parseInt(frontmatter.match(/price_cents:\s*(\d+)/)?.[1] || '0');
        const published = frontmatter.match(/published:\s*(true|false)/)?.[1] === 'true';

        if (!published) continue;

        // Look for preview image
        const preview = files.find((f) => /^preview\.(jpg|jpeg|png|svg|webp)$/i.test(f));
        const previewFile = preview ? `/slugs/${slug}/${preview}` : null;

        allItems.push({
          type: 'artwork',
          slug,
          title,
          date,
          priceCents,
          image: previewFile,
          url: `/${slug}`
        });
      } catch {}
    }

    // Check for education
    if (files.includes('course.txt')) {
      try {
        const content = await readFile(join(itemPath, 'course.txt'), 'utf-8');
        const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
        if (!frontmatterMatch) continue;

        const frontmatter = frontmatterMatch[1];
        const title = frontmatter.match(/title:\s*(.+)/)?.[1] || 'Untitled';
        const date = frontmatter.match(/date:\s*(.+)/)?.[1] || '';
        const priceCents = parseInt(frontmatter.match(/price_cents:\s*(\d+)/)?.[1] || '0');
        const published = frontmatter.match(/published:\s*(true|false)/)?.[1] === 'true';

        if (!published) continue;

        // Look for preview image
        const preview = files.find((f) => /^preview\.(jpg|jpeg|png|svg|webp)$/i.test(f));
        const previewFile = preview ? `/slugs/${slug}/${preview}` : null;

        allItems.push({
          type: 'education',
          slug,
          title,
          date,
          priceCents,
          image: previewFile,
          url: `/${slug}`
        });
      } catch {}
    }
  } catch {
    // Skip items we can't process
  }
}

// Sort by date (newest first)
allItems.sort((a, b) => {
  return new Date(b.date).getTime() - new Date(a.date).getTime();
});
---

<Layout>
  <main class="brochure">
    <!-- Filter Tabs -->
    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="all">All</button>
      <button class="filter-tab" data-filter="album">Albums</button>
      <button class="filter-tab" data-filter="writing">Writings</button>
      <button class="filter-tab" data-filter="artwork">Artwork</button>
      <button class="filter-tab" data-filter="education">Education</button>
    </div>

    <div class="shop-grid">
      <!-- Real shop items -->
      {allItems.map((item) => (
        <a
          href={item.url}
          class="shop-item"
          data-type={item.type}
        >
          <div class="card-content">
            {item.image ? (
              <div class="card-image">
                <img src={item.image} alt={item.title} />
              </div>
            ) : (
              <div class="card-image placeholder">
                <span class="type-badge">{item.type}</span>
              </div>
            )}
            <div class="card-info">
              <h3>{item.title}</h3>
              {item.priceCents > 0 && (
                <span class="price">${(item.priceCents / 100).toFixed(2)}</span>
              )}
            </div>
          </div>
        </a>
      ))}
    </div>

    <!-- Empty state -->
    <div class="empty-state" style="display: none;">
      <p>No items in this category yet.</p>
    </div>
  </main>
</Layout>

<script>
  // Filter functionality
  document.addEventListener('DOMContentLoaded', () => {
    const tabs = document.querySelectorAll('.filter-tab');
    const items = document.querySelectorAll('.shop-item:not(.featured-video)');
    const emptyState = document.querySelector('.empty-state');
    const shopGrid = document.querySelector('.shop-grid');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const filter = tab.dataset.filter;

        // Update active tab
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Filter items and count visible
        let visibleCount = 0;
        items.forEach(item => {
          if (filter === 'all' || item.dataset.type === filter) {
            item.style.display = 'block';
            visibleCount++;
          } else {
            item.style.display = 'none';
          }
        });

        // Show empty state if no items visible
        if (visibleCount === 0) {
          shopGrid.style.display = 'none';
          emptyState.style.display = 'block';
        } else {
          shopGrid.style.display = 'grid';
          emptyState.style.display = 'none';
        }
      });
    });
  });
</script>

<style>
  /* ===== FILTER TABS ===== */
  .filter-tabs {
    display: flex;
    gap: var(--space-xs);
    margin-bottom: var(--space-lg);
    justify-content: center;
    flex-wrap: wrap;
  }

  .filter-tab {
    background: var(--space-black);
    border: 2px solid var(--surface-border);
    color: var(--starlight);
    padding: var(--space-xs) var(--space-md);
    font-size: 0.9rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .filter-tab:hover {
    border-color: var(--surface-border-bright);
    color: var(--starlight);
  }

  .filter-tab.active {
    background: var(--primary-yellow);
    border-color: var(--primary-yellow);
    color: var(--space-black);
  }

  /* ===== SHOP GRID ===== */
  .shop-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-md);
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
  }

  /* Tablet: 3 columns */
  @media (max-width: 1024px) {
    .shop-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  /* Mobile: 2 columns */
  @media (max-width: 768px) {
    .shop-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-sm);
    }
  }

  /* ===== SHOP ITEMS ===== */
  .shop-item {
    background: var(--space-black);
    border: 2px solid var(--surface-border);
    aspect-ratio: 1;
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
    text-decoration: none;
    display: block;
  }

  .shop-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(102, 217, 239, 0.2);
    border-color: var(--primary-cyan);
  }

  /* ===== CARD CONTENT ===== */
  .card-content {
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .card-image {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: var(--surface-border);
  }

  .card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.2s ease;
  }

  .shop-item:hover .card-image img {
    transform: scale(1.05);
  }

  .card-image.placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .type-badge {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    opacity: 0.5;
  }

  .card-info {
    padding: var(--space-sm);
    background: var(--space-black);
  }

  .card-info h3 {
    font-size: 1rem;
    margin: 0 0 var(--space-xs) 0;
    color: var(--starlight);
    line-height: 1.3;
  }

  .price {
    display: inline-block;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--primary-cyan);
  }

  @media (max-width: 768px) {
    .card-info h3 {
      font-size: 0.9rem;
    }

    .price {
      font-size: 1rem;
    }
  }

  /* ===== EMPTY STATE ===== */
  .empty-state {
    text-align: center;
    padding: var(--space-2xl);
    color: var(--starlight);
    font-size: 1.1rem;
    background: var(--space-black);
    border: 2px solid var(--surface-border);
    max-width: 600px;
    margin: 0 auto;
  }
</style>
