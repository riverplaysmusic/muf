---
import Layout from "@/components/Layout.astro";
import { readdir, stat } from "node:fs/promises";
import { join } from "node:path";
import { parseSlugContent, type ContentItem } from "@/lib/content-parser";

// Scan all directories in public/slugs for content
const slugsDir = join(process.cwd(), "public", "slugs");
const items = await readdir(slugsDir);

const allItems: ContentItem[] = [];

for (const item of items) {
  const itemPath = join(slugsDir, item);

  try {
    const itemStat = await stat(itemPath);

    // Skip non-directories
    if (!itemStat.isDirectory()) continue;

    const parsedItems = await parseSlugContent(slugsDir, item);
    allItems.push(...parsedItems);
  } catch {
    // Skip items we can't process
  }
}

// Sort by date (newest first)
allItems.sort((a, b) => {
  return new Date(b.date).getTime() - new Date(a.date).getTime();
});
---

<Layout>
  <main class="brochure">
    <!-- Filter Tabs -->
    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="all">All</button>
      <button class="filter-tab" data-filter="album">Albums</button>
      <button class="filter-tab" data-filter="writing">Writings</button>
      <button class="filter-tab" data-filter="artwork">Artwork</button>
      <button class="filter-tab" data-filter="education">Education</button>
    </div>

    <div class="shop-grid">
      <!-- Real shop items -->
      {allItems.map((item) => (
        <a
          href={item.url}
          class="shop-item"
          data-type={item.type}
        >
          <div class="card-content">
            {item.image ? (
              <div class="card-image">
                <img src={item.image} alt={item.title} />
              </div>
            ) : (
              <div class="card-image placeholder">
                <span class="type-badge">{item.type}</span>
              </div>
            )}
            <div class="card-info">
              <h3>{item.title}</h3>
              {item.priceCents > 0 && (
                <span class="price">${(item.priceCents / 100).toFixed(2)}</span>
              )}
            </div>
          </div>
        </a>
      ))}
    </div>
  </main>
</Layout>

<script>
  // Filter functionality
  document.addEventListener('DOMContentLoaded', () => {
    const tabs = document.querySelectorAll('.filter-tab');
    const items = document.querySelectorAll('.shop-item');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const filter = tab.dataset.filter;

        // Update active tab
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Filter items
        items.forEach(item => {
          if (filter === 'all' || item.dataset.type === filter) {
            item.style.display = 'block';
          } else {
            item.style.display = 'none';
          }
        });
      });
    });
  });
</script>

<style>
  /* ===== FILTER TABS ===== */
  .filter-tabs {
    display: flex;
    gap: var(--space-xs);
    margin-bottom: var(--space-lg);
    justify-content: center;
    flex-wrap: wrap;
  }

  .filter-tab {
    background: var(--space-black);
    border: 2px solid var(--surface-border);
    color: var(--starlight);
    padding: var(--space-xs) var(--space-md);
    font-size: 0.9rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .filter-tab:hover {
    border-color: var(--surface-border-bright);
    color: var(--starlight);
  }

  .filter-tab.active {
    background: var(--primary-yellow);
    border-color: var(--primary-yellow);
    color: var(--space-black);
  }

  /* ===== SHOP GRID ===== */
  .shop-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-md);
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
  }

  /* Tablet: 2 columns */
  @media (max-width: 900px) {
    .shop-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  /* Mobile: 1 column */
  @media (max-width: 480px) {
    .shop-grid {
      grid-template-columns: 1fr;
      gap: var(--space-sm);
    }
  }

  /* ===== SHOP ITEMS ===== */
  .shop-item {
    background: var(--space-black);
    border: 2px solid var(--surface-border);
    aspect-ratio: 1;
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
    text-decoration: none;
    display: block;
  }

  .shop-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(102, 217, 239, 0.2);
    border-color: var(--primary-cyan);
  }

  /* ===== CARD CONTENT ===== */
  .card-content {
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .card-image {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: var(--surface-border);
  }

  .card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.2s ease;
  }

  .shop-item:hover .card-image img {
    transform: scale(1.05);
  }

  .card-image.placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .type-badge {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    opacity: 0.5;
  }

  .card-info {
    padding: var(--space-sm);
    background: var(--space-black);
  }

  .card-info h3 {
    font-size: 1rem;
    margin: 0 0 var(--space-xs) 0;
    color: var(--starlight);
    line-height: 1.3;
  }

  .price {
    display: inline-block;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--primary-cyan);
  }

  @media (max-width: 768px) {
    .card-info h3 {
      font-size: 0.9rem;
    }

    .price {
      font-size: 1rem;
    }
  }

</style>
