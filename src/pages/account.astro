---
import Layout from "@/components/Layout.astro";
---

<script>
  import { supabase } from "@/lib/supabase";

  const form = document.getElementById("auth-form") as HTMLFormElement;
  const emailInput = document.getElementById("email") as HTMLInputElement;
  const messageEl = document.getElementById("message") as HTMLElement;
  const formContainer = document.getElementById("form-container") as HTMLElement;
  const userContainer = document.getElementById("user-container") as HTMLElement;
  const loadingContainer = document.getElementById("loading-container") as HTMLElement;
  const userEmail = document.getElementById("user-email") as HTMLElement;
  const signOutBtn = document.getElementById("sign-out") as HTMLButtonElement;

  // Check localStorage first for instant rendering (no flicker)
  function checkLocalStorage() {
    // Supabase stores session in localStorage with this pattern
    const keys = Object.keys(localStorage).filter(key => key.includes('sb-') && key.includes('-auth-token'));

    if (keys.length > 0) {
      const sessionData = localStorage.getItem(keys[0]);
      if (sessionData) {
        try {
          const parsed = JSON.parse(sessionData);
          if (parsed?.access_token) {
            // Optimistically show logged-in state immediately
            loadingContainer.classList.add("hidden");
            showUserState("Loading...");
            return true;
          }
        } catch (e) {
          // Invalid JSON, fall through to show login
        }
      }
    }

    // No valid session in localStorage, show login form
    loadingContainer.classList.add("hidden");
    showFormState();
    return false;
  }

  // Verify session with Supabase (runs in background)
  async function checkSession() {
    const {
      data: { session },
    } = await supabase.auth.getSession();

    if (session) {
      // Update with real email
      showUserState(session.user.email || "");
    } else {
      // Session expired or invalid, show login
      showFormState();
    }
  }

  // Handle magic link sign in
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    messageEl.classList.remove("error", "success");
    messageEl.textContent = "";

    const email = emailInput.value.trim();

    if (!email) {
      messageEl.textContent = "Email is required";
      messageEl.classList.add("error");
      return;
    }

    const { error } = await supabase.auth.signInWithOtp({
      email,
      options: {
        emailRedirectTo: window.location.origin + "/account",
      },
    });

    if (error) {
      messageEl.textContent = error.message;
      messageEl.classList.add("error");
    } else {
      messageEl.textContent = "Check your email for the login link";
      messageEl.classList.add("success");
      emailInput.value = "";
    }
  });

  // Handle sign out
  signOutBtn.addEventListener("click", async () => {
    await supabase.auth.signOut();
    showFormState();
  });

  // Listen for auth state changes
  supabase.auth.onAuthStateChange((event, session) => {
    if (event === "SIGNED_IN" && session) {
      showUserState(session.user.email || "");
    } else if (event === "SIGNED_OUT") {
      showFormState();
    }
  });

  function showFormState() {
    formContainer.classList.remove("hidden");
    userContainer.classList.add("hidden");
  }

  function showUserState(email: string) {
    formContainer.classList.add("hidden");
    userContainer.classList.remove("hidden");
    userEmail.textContent = email;
  }

  // Check localStorage first (instant, no flicker)
  checkLocalStorage();

  // Then verify with Supabase (in background)
  checkSession();
</script>

<Layout>
  <main class="brochure">
    <!-- HERO -->
    <section class="hero">
      <header class="content">
        <h1 class="gradient-cyan-pink">Account</h1>
        <p class="subtitle">Sign in to access your library and purchases</p>
      </header>
    </section>

    <!-- AUTH FORM -->
    <section class="hero">
      <div class="content container-sm">
        <!-- Loading State -->
        <div id="loading-container" class="stack center">
          <p class="desc">Checking authentication...</p>
        </div>

        <!-- Sign In Form -->
        <div id="form-container" class="hidden">
          <h2 class="section-heading">Sign In</h2>
          <p class="desc">
            Enter your email and we'll send you a magic link to sign in. No
            password required.
          </p>

          <form id="auth-form" class="stack">
            <div class="form-field">
              <label for="email">Email</label>
              <input
                type="email"
                id="email"
                placeholder="your@email.com"
                required
              />
            </div>

            <div id="message" class="form-message"></div>

            <button type="submit" class="btn retro">Send Magic Link</button>
          </form>
        </div>

        <!-- Signed In State -->
        <div id="user-container" class="hidden">
          <h2 class="section-heading">Welcome Back</h2>

          <div class="stack center">
            <div class="glass">
              <h3>Signed in as</h3>
              <p id="user-email" class="highlight"></p>
            </div>

            <button id="sign-out" class="btn secondary">Sign Out</button>
          </div>
        </div>
      </div>
    </section>
  </main>
</Layout>
